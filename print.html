<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Single Node Homelab</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="hardware.html"><strong aria-hidden="true">1.</strong> Hardware</a></li><li class="chapter-item expanded "><a href="pws.html"><strong aria-hidden="true">2.</strong> Proxmox Workstation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="proxmox.html"><strong aria-hidden="true">2.1.</strong> Set up Proxmox</a></li><li class="chapter-item expanded "><a href="vgpu.html"><strong aria-hidden="true">2.2.</strong> Install vGPU driver</a></li><li class="chapter-item expanded "><a href="lg-client.html"><strong aria-hidden="true">2.3.</strong> Install Looking Glass client on Proxmox</a></li><li class="chapter-item expanded "><a href="linux-vm.html"><strong aria-hidden="true">2.4.</strong> Create Linux VM with dGPU/vGPU and Sunshine</a></li><li class="chapter-item expanded "><a href="win-vws.html"><strong aria-hidden="true">2.5.</strong> Create Windows vWS with vGPU and Looking Glass</a></li><li class="chapter-item expanded "><a href="extra-vm-conf.html"><strong aria-hidden="true">2.6.</strong> Additional VM configs</a></li></ol></li><li class="chapter-item expanded "><a href="services.html"><strong aria-hidden="true">3.</strong> Services</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="debian-guest.html"><strong aria-hidden="true">3.1.</strong> Create Debian Guest</a></li><li class="chapter-item expanded "><a href="samba-ad-dc.html"><strong aria-hidden="true">3.2.</strong> Set up Samba Active Directory Domain Controller</a></li><li class="chapter-item expanded "><a href="samba-ad-member.html"><strong aria-hidden="true">3.3.</strong> Join Samba Active Directory Domain</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Single Node Homelab</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/MakiseKurisu/single-node-homelab/tree/main" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<blockquote>
<p>Self hosting at home doesn't mean you need server racks or used enterprise leaf blowers. In fact, you could start with your existing gaming PC.</p>
</blockquote>
<h2 id="a-little-bit-of-background"><a class="header" href="#a-little-bit-of-background">A little bit of background</a></h2>
<p>Back when I was still a college student, a laptop was all I need. My music and games went everywhere with me, along with my study material. There was no need to host them elsewhere since I need to bring my laptop anyway.</p>
<p>After graduating, I no longer need to bring my laptop with me to work, and the game I was playing was CPU and GPU bounded, so a gaming tower was on my wish list. Coincidentally, as I also needed to do some IT works for the company, I discovered <a href="https://www.reddit.com/r/homelab/"><code>r/homelab</code></a> while learning different hypervisors. I had never heard about <a href="https://www.proxmox.com/en/">Proxmox</a> until <code>r/homelab</code> introduced it to me.</p>
<p>Fast forwards a few years, I have set up multiple single-node Proxmox installations for various personal and professional needs. I feel like right now is the time for me to properly document my setup and process (I do have <a href="https://gist.github.com/MakiseKurisu/">some gists</a> written that may or may not have helped me get the current job), so I can easily replicate my setup in the future, and also provide some resource back to the community.</p>
<h2 id="why-single-node"><a class="header" href="#why-single-node">Why single node?</a></h2>
<p>Single node is not a choice but a compromise. I wish to expand to a proper multi node HA setup soon, but the following conditions limited my ability to do so (which could happen to you as well):</p>
<ol>
<li>Initial investment. Multi node setup requires a greater initial investment, while the benefit of higher up-time is not as important for personal and even some professional use. Single node setup usually uses existing hardware so the opportunity cost is way smaller.</li>
<li>Performance, heat, electricity, space, and noise with used enterprise type of equipments. A common way to reduce the initial investment is to use 2nd hand enterprise equipment, and pay more on the operational cost. However, this is not possible for me since A, the operational cost as a renter is not a small amount (I pay electricity at the above commercial rate for example) so I want to minimize those as well; and B, it is hard to fit cheap consumer GPU on the rack server and CPU on those are usually quite old and clock limited, so not ideal for gaming. My first virtualized host was a ThinkStation D30 with dual Xeon E5-2667v2, and it wasn't much faster than my Thinkpad W540 during gaming.</li>
</ol>
<p>Currently, I'm eyeing ARM based hyper converged cluster as a cheaper way to have multi node cluster for service hosting. Then I can convert my single node host into a normal Linux machine for gaming. Until then, single node is the way for me.</p>
<h2 id="but-homelab-is-for-messing-with-the-enterprise-network-and-enterprise-hypervisor-and-so-on"><a class="header" href="#but-homelab-is-for-messing-with-the-enterprise-network-and-enterprise-hypervisor-and-so-on">But homelab is for messing with the enterprise network and enterprise hypervisor and so on!</a></h2>
<p>While this is true as that is what homelab means initially, right now <code>r/homelab</code> is more of a place for self-hosting home production infrastructure. Throughout this book, we are gonna host some services, set up VLANs, and create Active Directory domain with WPA-Enterprise wireless network. I think those are enterprisey enough to call what we create a homelab, and those are useful for small businesses (which is my background).</p>
<h2 id="then-why-there-are-a-lot-of-missing-chapters"><a class="header" href="#then-why-there-are-a-lot-of-missing-chapters">Then why there are a lot of missing chapters?</a></h2>
<p>For this book, I'm going to write it while I set up the system. Currently, I have 3 single node systems that need to be set up, so I'll pen the part I'm doing first before moving to other sections.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hardware"><a class="header" href="#hardware">Hardware</a></h1>
<p>As I'm managing a few different environments the hardware requirements are slightly different. Below suggestions are based on my personal environment.</p>
<h2 id="what-specs-should-i-look-for"><a class="header" href="#what-specs-should-i-look-for">What specs should I look for?</a></h2>
<p>First, check <a href="https://www.reddit.com/r/homelab/wiki/index"><code>r/homelab</code></a> and <a href="https://www.reddit.com/r/homelab/wiki/index"><code>r/DataHoarder</code></a> wiki. Their hardware guides should give you a good start.</p>
<h3 id="case"><a class="header" href="#case">Case</a></h3>
<p>For the case, I prefer ATX tower with a lot of hard drive bays. I have built 2 NZXT Source 220 based systems (one sold when I moved and one currently in use) and am very happy about this case. Sadly this cheap case is no longer in manufacture so you have to <em>source</em> it from 2nd hand market. It has 8 3.5-inch bays and 3 5.25 bays which can be adapted to 5 more 3.5-inch bays, giving you a total of 13 hard drive bays. Not all 8 3.5 bays are usable when GPU is plugged in, but that raw number combined with the fact that the price of an 18TB hard drive has been bearable due to crypto crash means this case can meet a lot of people's storage need.</p>
<p>If you cannot find a used Source 220, NZXT H2 has the same internal but worse cooling. From the same era Fractal Design R3 has 1 less 5.25 bay but 3.5 bays are more accessable and cooling is better than H2. For something current Fractal Design Meshify 2 (or XL) will be my next choice. Non XL with 11 3.5 bays can fulfill most users' need, but if you need more drives XL can equip up to 18 disks. Case has a very long life so if you are OK with how big it is this case should last you a long time.</p>
<h3 id="power-supply"><a class="header" href="#power-supply">Power supply</a></h3>
<p>Give 200W budget per CPU and 300W per GPU with 10W per disk, and buy PSU accordingly. Effiency is maxed around 50% load so it's okay to buy an oversized PSU. I'm running Seasonic FOCUS GX-850 for a 1C1G configuration with plan to add 2nd GPU in the future. Like the case, PSU last a long time, and a beefy one can be used longer. 2nd hand PSU is <strong>strongly discouraged</strong>, and only quality brands may be considered. The first system I built had an used Corsair PSU, and that one was fine. On my current system I did that again with a lower tier OEM because their used PSU has high wattage, and in the end I have 3 failed PSU, broken motherboard, and failed CPU.</p>
<h3 id="platform"><a class="header" href="#platform">Platform</a></h3>
<p>AM4 platform is EOL but there is still plenty of life left in this platform. You can also use AM4 cooler on AM5 so get a good one. Motherboards are recommended in the following order:</p>
<ol>
<li>ASRock Fatal1ty X370 Professional Gaming (what I was using)</li>
<li>ASRock X470 Taichi Ultimate</li>
<li>ASRock X370 Taichi (currently using)</li>
<li>X570 boards with multi-gig Ethernet, but just get ASRock X370 Taichi</li>
</ol>
<p>This is mostly based on network connectivity. X370 PG is the only X370 with 5GbE and X470 TU is the only X470 with 10GbE (excluding the ASRock Rack offering which is a lot more expensive). Being the halo products they, unfortunately, have very limited availability (especially X470 TU). In that case, I'll just go with X370 Taichi which is X370 PG minus the 5GbE, and rely on a USB or PCIe network card if I do need the extra port or bandwidth.</p>
<p>This bias for ASRock is also due to them being the first vendor to support Ryzen 5000 series on their X370 motherboard long before AMD eased the restriction, making them the only choice for the cheap used motherboard. Right now a lot of other vendors have added the support on their X370 boards as well, but they do not have better NIC so the calculation is still the same.</p>
<p>One final thing is <a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Ensuring_that_the_groups_are_valid">IOMMU group</a>. Motherboard with good IOMMU grouping means you can easily pass devices to the guest. ACS override is a hack and a source of instability so I don't think it is worth doing. For X370PG (and likely Taichi) the 2 X8/16 slots and the M.2 slot are all in separate IOMMU groups so you can use them for GPU passthrough. As for motherboard peripherals, most of them are in the same group except for the USB 3.0 controller and the audio controller. Not the best but I can live with this.</p>
<p>For CPU I'm currently using Ryzen 7 3700X which is the generation where AMD's gaming performance caught up with Intel and before they jacked up the price on 5000 series. 3700X being the cheaper 8-core offering from this generation with a box cooler means you can get them together for cheap. If your budget cannot afford this you can check earlier 8-core offering 1700/2700, as well as 6-core offering 1600AF/3600, based on your requirement of single and multi-threaded performance.</p>
<p>Moving forward there is also an upgrade path of 3900X/3950X and 5900X/5950X. 5900X is the most likely candidate for the improved core count and IPC, while likely being cheaper per core than 5950X in a few years. After 5900X is no longer performant AM5 platform and DDR5 should be mature enough with a good 2nd hand market.</p>
<h3 id="memory"><a class="header" href="#memory">Memory</a></h3>
<p>Right now I'm using 2x32GB 3200MHz ECC ram. My workstation has been 32GB for a long time so pairing another 32GB for services and 2nd GPU VM makes sense. This also leaves me an upgrade path to 128GB memory should I need that much (which can be possible if using vGPU for virtual desktops). So the recommendation is to put the double amount of memory you are currently using to the host.</p>
<h3 id="gpu"><a class="header" href="#gpu">GPU</a></h3>
<p>To use <a href="https://github.com/DualCoder/vgpu_unlock">vGPU unlock</a>, you need Maxwell/Pascal/Turing based Nvidia GPU and a good amount of vram to be useful. Some recommended cards are Tesla M40/P40 24GB for dedicated vGPU, or Geforce Titan X (Pascal) / Geforce GTX 1080 Ti for using the combined driver. Those cards have a good amount of vram while fast enough to be comfortably shared by many guests. Since we only have 2-3 PCIe slots for GPU a cheaper one basically &quot;wastes&quot; it, but they can be used nonetheless. With a Titan X you don't have to mess with cooling and can use as a passthrough GPU for now. Once you need a better GPU (that may not be supported by vGPU unlock), you can still share it with guests, maximizing the use-value.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proxmox-workstation"><a class="header" href="#proxmox-workstation">Proxmox Workstation</a></h1>
<p>In this section, we will set up a Proxmox-based VM host with virtual workstation capability. However, not everyone wants to run desktop directly on their server, so we offer 3 different configurations here:</p>
<ol>
<li>No host GPU driver. VFIO passthrough only.</li>
<li>Install vGPU driver, but no desktop environment to view VM's graphic output locally.</li>
<li>Install vGPU driver, host driver, and X11 with Looking Glass to view and control VM locally.</li>
<li>X11 Multiseats with NVENC unlocked so 4 users can run Looking Glass simultaneously a.k.a da dream.</li>
</ol>
<p>I planned to go with 3 initially and develop a solution for 4, but found out that Looking Glass's Linux host is immature at this moment, and there is way to much to install to for a mere Moonlight access. I'm currently going with 2, and passed RX460 to Linux with PRIME to run games on vGPU.</p>
<p>If you primarily use Windows and accept only accessing Linux via Moonlight, then you can go with 3.</p>
<p>The setup process has been roughly divided into those 3 parts, so just follow along and skip the section you don't need.</p>
<h2 id="hardware-configuration"><a class="header" href="#hardware-configuration">Hardware configuration</a></h2>
<ul>
<li>ASRock <del>Fatal1ty X370 Professional Gaming</del> X370 Taichi P7.10 Motherboard</li>
<li>AMD Ryzen 7 3700X Processor</li>
<li>Samsung DDR4 3200MHz 32GB Memory x2</li>
<li>Samsung 970 Evo 1TB NVMe SSD</li>
<li>Gigabyte 120GB SATA SSD</li>
<li>NVIDIA Titan X GPU</li>
<li>AMD RX460 GPU</li>
</ul>
<h2 id="proxmox-installation-tips"><a class="header" href="#proxmox-installation-tips">Proxmox installation tips</a></h2>
<p>Config BIOS first. Enable virtualization-related features like VT-d, IOMMU, SR-IOV, above 4G decode, etc.</p>
<p>Install Proxmox as you wish. On disk setup, I use <code>btrfs</code> RAID-1 instead of <code>zfs</code>. If you choose differently you will need to update some scripts later on as currently the storage path is hardcoded (search <code>local-btrfs</code>). This principle applies whenever you deviate from the guide.</p>
<p>I also used to run Proxmox on dual USB thumb drives on an internal USB 3.0 header. However, occasionally one of the USB drives will be missing, <code>btrfs</code> will fail to mount, and Proxmox will stop booting. Manual reset fixes the issue but that doesn't play well with Wake-on-Lan. As such I just install Proxmox to a SATA SSD instead.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-up-proxmox"><a class="header" href="#set-up-proxmox">Set up Proxmox</a></h1>
<h2 id="prepare-host"><a class="header" href="#prepare-host">Prepare host</a></h2>
<p>Since we will perform a lot of system configurations throughout this guide, I have created some Ansible playbooks to automate the task for you. You can download this repo to get it:</p>
<pre><code class="language-bash">git clone --depth 1 https://github.com/MakiseKurisu/single-node-homelab.git
cd single-node-homelab
</code></pre>
<p>Unless otherwise noted, we will always <strong>start</strong> running command from this folder. The command itself might lead you to somewhere else, but we will take you back in the end. We also assume you are running those commands under Linux. For Windows users you can install WSL2 and start following from there.</p>
<p>Now let's prep the Proxmox server to allow Ansible configuration, and also set some varibles for this project:</p>
<pre><code class="language-bash">./bootstrap provision proxmox_fqdn
# or when running non interactively, find out the available options
# Currently there is TUNA mirror option for users in China, and merged driver option for NVIDIA card to output graphic on Proxmox
./bootstrap
</code></pre>
<p>Some options are used later on if you don't know what they are for, but defaults should be sane enough for most people.</p>
<h2 id="basic-proxmox-configuration"><a class="header" href="#basic-proxmox-configuration">Basic Proxmox Configuration</a></h2>
<p>Run the following command in the same folder to perform some basic Proxmox setup:</p>
<pre><code class="language-bash"># Review the tasks...
./bootstrap ansible proxmox-init --list-tasks
# and run!
./bootstrap ansible proxmox-init
</code></pre>
<p>The playbook will install 2 helper scripts. <code>lsiommu</code> will show you the IOMMU grouping on your machine. While <code>pve-helper</code> is a PVE snippet that can run some configuration tasks when you start/stop a VM.</p>
<p>Before you continue to the next chapter, we recommend you to first download the necessary system ISO and drivers first. Luckily <code>bootstrap</code> can do most of those for you, except for the Windows ISO. Go to <a href="https://www.microsoft.com/software-download/windows11">Microsoft</a> to download Windows 11 ISO, and save it to the <code>resource</code> folder. We will also download some additional ISOs, and upload them to Proxmox here:</p>
<pre><code class="language-bash">mkdir -p ./resource
wget --content-disposition -P &quot;./resource&quot; &quot;some_microsoft_iso_link&quot; &amp;
./bootstrap iso --all
</code></pre>
<p>Some commands later on expect the necessary files are already downloaded in <code>./resource</code> folder.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-vgpu-driver"><a class="header" href="#install-vgpu-driver">Install vGPU driver</a></h1>
<p>Run the following command to install vGPU or merged driver, along with <code>vgpu-unlock_rs</code>.</p>
<pre><code class="language-bash">./bootstrap ansible vgpu
</code></pre>
<p>If you passed <code>-v</code> option during provision, we also installed <code>xinit</code> in this step so the NVIDIA driver can detect the correct Xorg folder.</p>
<p>The script is designed for Titan X and <code>nvidia-50</code> profile. For other configuration please edit <code>Patch vgpuConfig.xml</code> in <code>vgpu.yml</code> to fake a <strong>vGPU capable card</strong> (some options listed in <a href="https://github.com/VGPU-Community-Drivers/vGPU-Unlock-patcher">vGPU-Unlock-patcher</a>) and a <strong>Quadro card</strong> with your desired profile in <code>profile_override.toml</code>. They do not use the same PCI device ID.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-looking-glass-client-on-proxmox"><a class="header" href="#install-looking-glass-client-on-proxmox">Install Looking Glass client on Proxmox</a></h1>
<p>Debian 11 does not ship <code>cage</code>, <code>sway</code> doesn't work once NVIDIA driver is installed (tried Debian shipped one and a community build), <code>weston</code> doesn't work as well. As such we will use <code>i3</code> to provide a minimal desktop environment to run Looking Glass.</p>
<pre><code class="language-bash">./bootstrap ansible lg
</code></pre>
<p>We also customized <code>/etc/skel</code> a bit, so any new user we added later will run Looking Glass automatically when they log in.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-linux-vm-with-dgpuvgpu-and-sunshine"><a class="header" href="#create-linux-vm-with-dgpuvgpu-and-sunshine">Create Linux VM with dGPU/vGPU and Sunshine</a></h1>
<p>The reason we want to create Linux VM with dGPU is because Looking Glass Linux Host is immature. Also you cannot passthrough vGPU with other PCIe devices, so there goes the dream to run dGPU and vGPU using PRIME. But no matter which GPU you choose, the way to do it is pretty similar, so we will have them here together.</p>
<p>Create your Linux VM in Proxmox's GUI. Some personal perferences and tips with important one in bold:</p>
<ul>
<li>Infrastrucure VMID start at 101, Service VMID starts at 201, and Client VMID starts at 301. In <code>Datacenter</code>-<code>Options</code>-<code>Next Free VMID Range</code> you can set to <code>301-399</code> for your Client VMs.</li>
<li>VMID is also mapped to IP address from XYY to 192.168.X.YY. This is done in the router with static DHCP lease.</li>
<li>Enable <code>Start at boot</code> so unprivileged users can use VM without additional settings.</li>
<li>Under <code>System</code> tab, use <code>q35</code> machine, <code>OVMF (UEFI)</code> BIOS,<code> VirtIO-GPU</code> graphic card, <code>VirtIO SCSI Single</code> SCSI controller, and check <code>Add TPM</code> &amp; <code>Qemu Agent</code>.</li>
<li><strong>Uncheck <code>Pre-Enroll keys</code> in <code>System</code> tab!</strong> This will <a href="https://192.168.2.191:8006/pve-docs/chapter-qm.html#qm_bios_and_uefi">enable Secure Boot</a> which is not what we want with <a href="https://looking-glass.io/docs/B5.0.1/install/#installing-the-ivshmem-driver">Looking Glass driver</a>, or with unsigned kernel like Arch or Manjaro.</li>
<li>For <code>Disks</code> tab, use <code>SCSI</code> bus, check <code>Discard</code>, <code>SSD emulation</code>, and <code>IO thread</code>.</li>
<li><strong>Use <code>Write through</code> for <code>Cache</code> in <code>Disks</code> tab!</strong> <a href="https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_btrfs">Btrfs honors <code>O_DIRECT</code></a> so need to use a <a href="https://pve.proxmox.com/wiki/Performance_Tweaks#Small_Overview">cache mode without this flag</a>.</li>
<li>Use <code>host</code> CPU type.</li>
<li><strong>Uncheck <code>Ballooning Device</code>!</strong> This doesn't play nicely with Nvidia drivers and could make VM unusable.</li>
<li>Use <code>VirtIO (paravirtualized)</code> network card.</li>
<li><strong>Do not check <code>Start after created</code>!</strong> We will make more changes before we start the VM.</li>
</ul>
<p>After those steps I have created a VM with VMID <code>301</code>. Now go to <code>Hardware</code> and add <code>Serial Port</code> and <code>VirtIO RNG</code>, which are optional since you can also use SSH to control the VM. If you have no hardware audio card to passthrough you will need to add an <code>Audio Device</code>. If you have a working vGPU setup, you can now add <code>PCI Device</code> to your VM, and <code>Meditated Device</code> will say <code>Yes</code> for your GPU. Select it, choose the profile in <code>MDev Type</code>, and check every available options. Otherwise, just add your other PCIe devices here.</p>
<p>If you use dGPU it is easier to set <code>Display</code> to <code>none</code> here, add your dGPU, and install on your physical screen, so the driver is auto installed by your installer. This is the case for Manjaro, where installing with both dGPU and Virtio-GPU results in no graphical shell in either places, and installing with Virtio-GPU only results in blackscreen once switched to AMD dGPU. If your distro have better support on graphic, you can have both enabled, or only Virtio-GPU. This way you can use <code>virt-viewer</code> to control the VM, instead of Proxmox's noVNC web console or hooking up additional hardware.</p>
<p>Once you can log in the guest system, let's run the following commands to enable remote access:</p>
<pre><code class="language-bash">sudo systemctl enable --now sshd
ip a
</code></pre>
<p>The reason we do this is that once you can remote console, you can copy and paste command in your local terminal, which is not something you can do with Proxmox's noVNC. Here we will show you how to use the VirtIO serial console:</p>
<pre><code class="language-bash">PVE_IP=&quot;$(grep &quot;ansible_host&quot; hosts | tr -s ' ' | cut -d ' ' -f 3)&quot;
ssh root@$PVE_IP
# Below commands in Proxmox SSH
VMID=301
qm terminal $VMID
#############
# You will see a message telling you that press Ctrl+O exit this terminal.
# Unlike SSH, Ctrl+O won't kill the current session.
#############
## Below commands in Manjaro Terminal
## Login with your account first
chsh -s /usr/bin/zsh
logout
# Relog in to switch shell
sudo sed -i &quot;s/#ParallelDownloads/ParallelDownloads/&quot; /etc/pacman.conf
# Obviously use something else if you are not in China
sudo pacman-mirrors -c China
sudo pacman -Syu --noconfirm yay
yay -S --noconfirm --needed base-devel linux515-headers looking-glass obs-plugin-looking-glass looking-glass-module-dkms sunshine plasma-wayland-session qemu-guest-agent
sudo systemctl enable --now serial-getty@ttyS0 qemu-guest-agent
# Update user below to match your username
cat &lt;&lt; EOF | sudo tee /etc/udev/rules.d/99-kvmfr.rules
SUBSYSTEM==&quot;kvmfr&quot;, OWNER=&quot;user&quot;, GROUP=&quot;root&quot;, MODE=&quot;0660&quot;
EOF
cat &lt;&lt; EOF &gt; ~/.looking-glass-client.ini
[app]
shmFile=/dev/kvmfr0

[win]
fullScreen=yes
autoResize=yes
jitRender=no # yes will crash X11 server. DO NOT ENABLE!

[input]
rawMouse=yes

[spice]
host=192.168.1.1 # change to your Windows VM IP
port=5900
captureOnStart=yes

EOF
sudo poweroff
# Now you are back in Proxmox SSH
</code></pre>
<p>Now we will need to some additional settings to enable VM to VM Looking Glass access:</p>
<pre><code class="language-bash">VMID=301
# Below commands in Proxmox SSH
qm set $VMID --hookscript=local-btrfs:snippets/pve-helper
cat &lt;&lt; EOF &gt;&gt; /etc/pve/qemu-server/$VMID.conf
tablet: 0
ivshmem: size=128,name=302
EOF
sed -E -i &quot;s/^ide2.*$//&quot; /etc/pve/qemu-server/$VMID.conf
</code></pre>
<p>We put <code>name=302</code> in <code>$VMID.conf</code> because by default, Proxmox will create IVSHMEM file suffixed with your VMID. However, we want to access Windows (VMID will be 302) through Looking Glass, so we need to match the name for IVSHMEM file.</p>
<p>Now you have complete your Linux VM setup.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-windows-vws-with-vgpu-and-looking-glass"><a class="header" href="#create-windows-vws-with-vgpu-and-looking-glass">Create Windows vWS with vGPU and Looking Glass</a></h1>
<p>Create your Windows VM similarly to how we created Linux VM. In this example I created a VM with VMID <code>302</code>. You can also add the same optional devices, even serial since Windows also supports serial console in the form of Windows Emergency Management Services. What's not optional though, is that you need to add 2 <code>CD/DVD Drive</code>, with <code>virtio-win.iso</code> under IDE bus 0, and <code>lg-win.iso</code> under SATA bus 1. Settings here affect how Windows assigns drive letters, so if you are not following this setting, be careful later on when there is a path listed. Finally, add your vGPU here. Windows can support both Virtio-GPU and vGPU at the same time.</p>
<p>Now start VM and install Windows. When Windows Installer asks you <code>Where do you want to install Windows?</code>, click <code>Load driver</code>, and <code>Browse</code> <code>E:\amd64\w11</code> to install <code>Red Hat VirtIO SCSI pass-through controller</code>, <strong>AND</strong> <code>E:\NetKVM\w11\amd64\</code> to install <code>Red Hat VirtIO Ethernet Adapter</code>. Windows is moving towards more online services, and you have to use an online account in Home edition. Pro edition is <em>currently</em> unaffected, but let's install the network driver just in case.</p>
<p>During OOBE setup you can create account <strong>without password</strong> so you don't have to click through 3 password recovery questions. After OOBE is done, go to <code>Settings</code> and enable RDP, add password (required for RDP login).</p>
<p>You now need to install VirtIO drivers with everything selected (<code>E:\virtio-win-guest-tools.exe</code>), NVIDIA driver, <a href="https://looking-glass.io/docs/B5.0.1/install/#installing-the-ivshmem-driver">IVSHMEM driver</a> under <code>Win10\amd64</code> folder (<strong>make sure it reads <code>IVSHMEM Device</code> in <code>Device Manager</code></strong>, not <code>PCI standard RAM Controller</code>), and Looking Glass, which all located under <code>D:\</code>. Go to <code>Services</code> and make sure <code>Looking Glass (host)</code> service is <code>Running</code>, and you have completed the Windows VM setup. After drivers are installed, disable sleep (will mess up IVSHMEM file on Proxmox), and shut down Windows.</p>
<p>Like Linux you will now run a few commands:</p>
<pre><code class="language-bash">VMID=302
LG_USER=&quot;domain_user&quot;
# Below commands in Proxmox SSH
qm set $VMID --hookscript=local-btrfs:snippets/pve-helper
cat &lt;&lt; EOF &gt;&gt; /etc/pve/qemu-server/$VMID.conf
tablet: 0
ivshmem: size=128
EOF
sed -E -i -e &quot;s/^ide.*$//&quot; -e &quot;s/^sata.*$//&quot; -e &quot;s/^vga.*$/vga: none/&quot; /etc/pve/qemu-server/$VMID.conf
echo &quot;args: -uuid $(qm showcmd $VMID | sed -E &quot;s_.*/(\w*-0000-0000-0000-\w*).*_\1_&quot;) -cpu host,hv_ipi,hv_relaxed,hv_reset,hv_runtime,hv_spinlocks=0x1fff,hv_stimer,hv_synic,hv_time,hv_vapic,hv_vendor_id=AuthenticAMD,hv_vpindex,kvm=off,+kvm_pv_eoi,+kvm_pv_unhalt,-hypervisor -device virtio-mouse-pci -device virtio-keyboard-pci -device virtio-serial-pci -chardev spicevmc,id=vdagent,name=vdagent -device virtserialport,chardev=vdagent,name=com.redhat.spice.0 -spice addr=0.0.0.0,port=5900,disable-ticketing=on&quot; &gt;&gt; /etc/pve/qemu-server/$VMID.conf
</code></pre>
<p>You will then decide if you only want to access Looking Glass from local Proxmox host, or via network (like from Linux VM). If you want to allow network access, you will need to use a normal socket for SPICE. Replace</p>
<pre><code>-spice addr=0.0.0.0,port=5900,disable-ticketing=on
</code></pre>
<p>with this</p>
<pre><code>-spice unix=on,addr=/run/lg$VMID.socket,disable-ticketing=on
</code></pre>
<p>We suggest you reboot Proxmox once you finish set up before you boot both Linux and Windows VM up with intention to use VM-to-VM Looking Glass. Sometimes Proxmox will create IVSHMEM file with a different inode, so VM stops talking to each other. Reboot gurantees they will have the same inode.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="additional-vm-configs"><a class="header" href="#additional-vm-configs">Additional VM configs</a></h1>
<h2 id="manjaro"><a class="header" href="#manjaro">Manjaro</a></h2>
<pre><code class="language-bash">yay -Syu --needed --noconfirm github-cli visual-studio-code-bin github-desktop-bin \
    manjaro-asian-input-support-fcitx5 fcitx5-chinese-addons \
    kicad \
    libreoffice-fresh chromium thunderbird \
    moonlight-qt-bin remmina freerdp \
    discord mattermost-desktop teams skypeforlinux-stable-bin deepin-wine-wechat deepin-wine-tim wemeet-bin v4l2loopback-dkms
yay -Syu --needed manjaro-pipewire
cat &lt;&lt; EOF | sudo tee -a /etc/environment
MOZ_ENABLE_WAYLAND=1
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx
EOF
cat &lt;&lt; EOF | sudo tee /usr/share/applications/looking-glass-client.desktop
[Desktop Entry]
Version=1.0
Name=Looking Glass Client
Comment=Low latency framebuffer viewer
Exec=looking-glass-client
Terminal=false
X-MultipleArgs=false
Type=Application
Categories=Game;
StartupNotify=true
EOF
update-desktop-database
</code></pre>
<h2 id="windows"><a class="header" href="#windows">Windows</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="services"><a class="header" href="#services">Services</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="create-debian-guest"><a class="header" href="#create-debian-guest">Create Debian Guest</a></h1>
<h2 id="configure"><a class="header" href="#configure">Configure</a></h2>
<pre><code>apt update &amp;&amp; apt install -y ssh &amp;&amp; systemctl enable ssh &amp;&amp; poweroff

su -
apt install -y bash-completion tmux sudo
apt install -y samba winbind libnss-winbind libpam-winbind krb5-user libpam-krb5
apt install -y systemd-timesyncd
timedatectl set-ntp true
systemctl enable --now serial-getty@ttyS0
nano /etc/network/interfaces
# Add `iface enp6s18 inet6 dhcp`
usermod -a -G sudo YOUR_USER
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="set-up-samba-active-directory-domain-controller"><a class="header" href="#set-up-samba-active-directory-domain-controller">Set up Samba Active Directory Domain Controller</a></h1>
<p>In this chapter, we will set up an AD domain controller with DNS and NTP services.</p>
<h2 id="install-dependency"><a class="header" href="#install-dependency">Install dependency</a></h2>
<p>To be updated</p>
<pre><code>sudo apt install -y smbclient ntp
</code></pre>
<h2 id="preparation"><a class="header" href="#preparation">Preparation</a></h2>
<p>If you follow <a href="./debian-guest.html">Debian guest</a> chapter then below are all you need to do. Otherwise, check <a href="https://wiki.samba.org/index.php/Setting_up_Samba_as_an_Active_Directory_Domain_Controller#Preparing_the_Installation">the official Samba Wiki</a>.</p>
<pre><code>sudo systemctl disable --now smbd nmbd winbind
sudo sed -nie &quot;p; s/127.0.1.1/$(ip -o -6 addr | grep -v -e &quot;1: lo&quot; -e &quot;dynamic&quot; -e &quot;link&quot; | head -n 1 | awk '{print $4}' | cut -d/ -f1)/p&quot; /etc/hosts
sudo sed -ie &quot;s/127.0.1.1/$(ip -o -4 addr | grep -v &quot;1: lo&quot; | awk '{print $4}' | cut -d/ -f1)/&quot; /etc/hosts
sudo rm -rf /etc/samba/smb.conf /run/samba /var/lib/samba /var/cache/samba /etc/krb5.conf
sudo mkdir -p /var/lib/samba/private
</code></pre>
<h2 id="provision"><a class="header" href="#provision">Provision</a></h2>
<p>Default configs work fine so just need to put your password here:</p>
<pre><code>sudo samba-tool domain provision --interactive --use-rfc2307
sudo nano /etc/samba/smb.conf
#
# Add the following line in [global] section
#
# template shell = /bin/bash
# template homedir = /home/%U
# winbind use default domain = yes
#
sudo sed -i -e &quot;s/passwd:\s*files/passwd: files winbind/&quot; -e &quot;s/group:\s*files/group: files winbind/&quot; /etc/nsswitch.conf
echo &quot;session required pam_mkhomedir.so&quot; | sudo tee -a /etc/pam.d/common-session
echo &quot;domain YOUR.DNS.DOMAIN&quot; | sudo tee -a /etc/resolv.conf
echo &quot;search YOUR.DNS.DOMAIN&quot; | sudo tee -a /etc/resolv.conf
sudo cp /var/lib/samba/private/krb5.conf /etc/krb5.conf
sudo sed -ie &quot;s/default kod notrap nomodify nopeer noquery limited/default kod notrap nomodify nopeer limited mssntp/g&quot; /etc/ntp.conf
echo &quot;ntpsigndsocket /var/lib/samba/ntp_signd/&quot; | sudo tee -a /etc/ntp.conf
sudo chown root:ntp /var/lib/samba/ntp_signd
sudo systemctl restart ntp
</code></pre>
<p>Now update your OpenWrt setting to use AD DC's DNS:</p>
<pre><code>uci set dhcp.@dnsmasq[0].domain='YOUR.DNS.DOMAIN'
uci set dhcp.@dnsmasq[0].local='/YOUR.DNS.DOMAIN/AD.DOMAIN.CONTROLLER.IP'
uci add_list dhcp.guest.dhcp_option='42,AD.DOMAIN.CONTROLLER.IP' # NTP Server
uci commit
/etc/init.d/dnsmasq restart
</code></pre>
<h2 id="check-if-ad-dc-is-working"><a class="header" href="#check-if-ad-dc-is-working">Check if AD DC is working</a></h2>
<pre><code>AD_REALM=SAMDOM.EXAMPLE.COM
DC=DC01

sudo samba # automatically running in the background
smbclient -L localhost -N
smbclient //localhost/netlogon -UAdministrator -c 'ls'
host -t SRV _ldap._tcp.${AD_REALM}
host -t SRV _kerberos._udp.${AD_REALM}
host -t A ${DC}.${AD_REALM}.
kinit administrator
klist
</code></pre>
<h2 id="enable-sambe-permanently"><a class="header" href="#enable-sambe-permanently">Enable Sambe permanently</a></h2>
<pre><code>sudo systemctl unmask samba-ad-dc
sudo systemctl enable samba-ad-dc
sudo reboot
</code></pre>
<h2 id="reference"><a class="header" href="#reference">Reference</a></h2>
<p><a href="https://wiki.samba.org/index.php/Setting_up_Samba_as_an_Active_Directory_Domain_Controller">Samba Wiki</a>
<a href="https://wiki.samba.org/index.php/Configuring_Winbindd_on_a_Samba_AD_DC">Samba Wiki-Winbind</a>
<a href="https://wiki.archlinux.org/title/Samba/Active_Directory_domain_controller">Arch Wiki</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="join-samba-active-directory-domain"><a class="header" href="#join-samba-active-directory-domain">Join Samba Active Directory Domain</a></h1>
<p>In this chapter, we will join our existing AD domain.</p>
<h2 id="preparation-1"><a class="header" href="#preparation-1">Preparation</a></h2>
<pre><code>sudo systemctl stop smbd nmbd winbind
sudo rm -rf /etc/samba/smb.conf /run/samba /var/lib/samba /var/cache/samba /etc/krb5.conf
sudo mkdir -p /var/lib/samba/private
sudo sed -ie &quot;s/^127.0.1.1.*$//&quot; /etc/hosts
</code></pre>
<h2 id="check-if-ad-dns-is-working"><a class="header" href="#check-if-ad-dns-is-working">Check if AD DNS is working</a></h2>
<pre><code>AD_REALM=SAMDOM.EXAMPLE.COM
DC=DC01

host -t SRV _ldap._tcp.${AD_REALM}
host -t SRV _kerberos._udp.${AD_REALM}
host -t A ${DC}.${AD_REALM}.
host AD.DOMAIN.CONTROLLER.IP
</code></pre>
<h2 id="configure-kerberos-and-samba"><a class="header" href="#configure-kerberos-and-samba">Configure Kerberos and Samba</a></h2>
<pre><code>AD_REALM=SAMDOM.EXAMPLE.COM
WORKGROUP=SAMDOM

cat &lt;&lt; EOF | sudo tee /etc/krb5.conf
[libdefaults]
    default_realm = ${AD_REALM}
    dns_lookup_realm = false
    dns_lookup_kdc = true
EOF

cat &lt;&lt; EOF | sudo tee /etc/samba/smb.conf
[global]
    security = ADS
    workgroup = ${WORKGROUP}
    realm = ${AD_REALM}

    idmap config * : backend = autorid
    idmap config * : range = 10000-9999999

    username map = /usr/local/samba/etc/user.map

    template shell = /bin/bash
    template homedir = /home/%U
    winbind use default domain = yes
EOF

sudo mkdir -p /usr/local/samba/etc/
echo '!root = ${WORKGROUP}\Administrator' | sudo tee /usr/local/samba/etc/user.map
</code></pre>
<h2 id="joining-domain"><a class="header" href="#joining-domain">Joining domain</a></h2>
<pre><code>sudo net ads join -U Administrator
sudo systemctl start smbd nmbd winbind
sudo sed -i -e &quot;s/passwd:\s*files/passwd: files winbind/&quot; -e &quot;s/group:\s*files/group: files winbind/&quot; /etc/nsswitch.conf
echo &quot;session required pam_mkhomedir.so&quot; | sudo tee -a /etc/pam.d/common-session
</code></pre>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<pre><code>wbinfo --ping-dc
getent passwd SAMDOM\\Administrator
getent group &quot;SAMDOM\\Domain Users&quot;
touch /tmp/samba_test
sudo chown &quot;SAMDOM\\Administrator:SAMDOM\\Domain Users&quot; /tmp/samba_test
ls -la /tmp/samba_test
</code></pre>
<h2 id="reference-1"><a class="header" href="#reference-1">Reference</a></h2>
<p><a href="https://wiki.samba.org/index.php/Setting_up_Samba_as_a_Domain_Member">Samba Wiki</a>
<a href="https://wiki.samba.org/index.php/Authenticating_Domain_Users_Using_PAM">Samba Wiki-Winbind</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
