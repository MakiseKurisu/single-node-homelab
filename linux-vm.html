<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Create Linux VM with dGPU/vGPU and Sunshine - Single Node Homelab</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="hardware.html"><strong aria-hidden="true">1.</strong> Hardware</a></li><li class="chapter-item expanded "><a href="pws.html"><strong aria-hidden="true">2.</strong> Proxmox Workstation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="proxmox.html"><strong aria-hidden="true">2.1.</strong> Set up Proxmox</a></li><li class="chapter-item expanded "><a href="vgpu.html"><strong aria-hidden="true">2.2.</strong> Install vGPU driver</a></li><li class="chapter-item expanded "><a href="lg-client.html"><strong aria-hidden="true">2.3.</strong> Install Looking Glass client on Proxmox</a></li><li class="chapter-item expanded "><a href="linux-vm.html" class="active"><strong aria-hidden="true">2.4.</strong> Create Linux VM with dGPU/vGPU and Sunshine</a></li><li class="chapter-item expanded "><a href="win-vws.html"><strong aria-hidden="true">2.5.</strong> Create Windows vWS with vGPU and Looking Glass</a></li></ol></li><li class="chapter-item expanded "><a href="services.html"><strong aria-hidden="true">3.</strong> Services</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="debian-guest.html"><strong aria-hidden="true">3.1.</strong> Create Debian Guest</a></li><li class="chapter-item expanded "><a href="samba-ad-dc.html"><strong aria-hidden="true">3.2.</strong> Set up Samba Active Directory Domain Controller</a></li><li class="chapter-item expanded "><a href="samba-ad-member.html"><strong aria-hidden="true">3.3.</strong> Join Samba Active Directory Domain</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Single Node Homelab</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/MakiseKurisu/single-node-homelab/tree/main" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/MakiseKurisu/single-node-homelab/edit/main/doc/linux-vm.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="create-linux-vm-with-dgpuvgpu-and-sunshine"><a class="header" href="#create-linux-vm-with-dgpuvgpu-and-sunshine">Create Linux VM with dGPU/vGPU and Sunshine</a></h1>
<p>The reason we want to create Linux VM with dGPU is because Looking Glass Linux Host is immature. Also you cannot passthrough vGPU with other PCIe devices, so there goes the dream to run dGPU and vGPU using PRIME. But no matter which GPU you choose, the way to do it is pretty similar, so we will have them here together.</p>
<p>Create your Linux VM in Proxmox's GUI. Some personal perferences and tips with important one in bold:</p>
<ul>
<li>Infrastrucure VMID start at 101, Service VMID starts at 201, and Client VMID starts at 301. In <code>Datacenter</code>-<code>Options</code>-<code>Next Free VMID Range</code> you can set to <code>301-399</code> for your Client VMs.</li>
<li>VMID is also mapped to IP address from XYY to 192.168.X.YY. This is done in the router with static DHCP lease.</li>
<li>Enable <code>Start at boot</code> so unprivileged users can use VM without additional settings.</li>
<li>Under <code>System</code> tab, use <code>q35</code> machine, <code>OVMF (UEFI)</code> BIOS,<code> VirtIO-GPU</code> graphic card, <code>VirtIO SCSI Single</code> SCSI controller, and check <code>Add TPM</code> &amp; <code>Qemu Agent</code>.</li>
<li><strong>Uncheck <code>Pre-Enroll keys</code> in <code>System</code> tab!</strong> This will <a href="https://192.168.2.191:8006/pve-docs/chapter-qm.html#qm_bios_and_uefi">enable Secure Boot</a> which is not what we want with <a href="https://looking-glass.io/docs/B5.0.1/install/#installing-the-ivshmem-driver">Looking Glass driver</a>, or with unsigned kernel like Arch or Manjaro.</li>
<li>For <code>Disks</code> tab, use <code>SCSI</code> bus, check <code>Discard</code>, <code>SSD emulation</code>, and <code>IO thread</code>.</li>
<li><strong>Use <code>Write through</code> for <code>Cache</code> in <code>Disks</code> tab!</strong> <a href="https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_btrfs">Btrfs honors <code>O_DIRECT</code></a> so need to use a <a href="https://pve.proxmox.com/wiki/Performance_Tweaks#Small_Overview">cache mode without this flag</a>.</li>
<li>Use <code>host</code> CPU type.</li>
<li><strong>Uncheck <code>Ballooning Device</code>!</strong> This doesn't play nicely with Nvidia drivers and could make VM unusable.</li>
<li>Use <code>VirtIO (paravirtualized)</code> network card.</li>
<li><strong>Do not check <code>Start after created</code>!</strong> We will make more changes before we start the VM.</li>
</ul>
<p>After those steps I have created a VM with VMID <code>301</code>. Now go to <code>Hardware</code> and add <code>Serial Port</code> and <code>VirtIO RNG</code>, which are optional since you can also use SSH to control the VM. If you have no hardware audio card to passthrough you will need to add an <code>Audio Device</code>. If you have a working vGPU setup, you can now add <code>PCI Device</code> to your VM, and <code>Meditated Device</code> will say <code>Yes</code> for your GPU. Select it, choose the profile in <code>MDev Type</code>, and check every available options. Otherwise, just add your PCIe devices here.</p>
<p>Now start VM and install your favorite distro. Right now uou can use a Spice viewer like <code>virt-viewer</code> to control the VM, instead of Proxmox's noVNC web console. For distro I'm using Manjaro. Once everything is done, let's run the following commands in the Spice viewer or noVNC to enable remote access:</p>
<pre><code class="language-bash">sudo systemctl enable --now sshd serial-getty@ttyS0
</code></pre>
<p>The reason we do this is that once you can remote console, you can copy and paste command in your local terminal, which is not something you can do with Proxmox's noVNC. You can then find the IP address on Proxmox's VM page. Here we will show you how to use the VirtIO serial console, since we will also run some commands in Proxmox as well:</p>
<pre><code class="language-bash">PVE_IP=&quot;$(grep &quot;ansible_host&quot; hosts | tr -s ' ' | cut -d ' ' -f 3)&quot;
ssh root@$PVE_IP
# Below commands in Proxmox SSH
VMID=301
qm terminal $VMID
#############
# You will see a message telling you that press Ctrl+O exit this terminal.
# Unlike SSH, Ctrl+O won't kill the current session.
#############
## Below commands in Manjaro Terminal
## Login with your account first
chsh -s /usr/bin/zsh
sudo sed -i &quot;s/#ParallelDownloads/ParallelDownloads/&quot; /etc/pacman.conf
sudo pacman-mirrors -c China # Obviously use something else if you are not in China
sudo pacman -Syu --noconfirm yay
yay -S --noconfirm --needed base-devel linux515-headers dkms looking-glass obs-plugin-looking-glass looking-glass-module-dkms sunshine plasma-wayland-session
cat &lt;&lt; EOF &gt; /etc/X11/xorg.conf.d/20-amdgpu.conf
Section &quot;Device&quot;
     Identifier &quot;AMD&quot;
     Driver &quot;amdgpu&quot;
     Option &quot;VariableRefresh&quot; &quot;true&quot;
EndSection
EOF
# Update user below to match your username
cat &lt;&lt; EOF | sudo tee /etc/tmpfiles.d/10-looking-glass.conf
#Type Path        Mode UID  GID  Age Argument
f     /dev/kvmfr0 0660 user root -
EOF
sudo poweroff
# Now you are back in Proxmox SSH
</code></pre>
<pre><code class="language-bash"># Below commands in Proxmox SSH
qm set $VMID --hookscript=local-btrfs:snippets/pve-helper
sed -i -E -e 's/^vga:.*$/vga: none/' -e 's/^ide2:.*$//' /etc/pve/qemu-server/$VMID.conf
cat &lt;&lt; EOF &gt;&gt; /etc/pve/qemu-server/$VMID.conf
tablet: 0
ivshmem: size=64,name=302
EOF
echo &quot;args: -uuid $(qm showcmd $VMID | sed -E &quot;s_.*/(\w*-0000-0000-0000-\w*).*_\1_&quot;) -cpu host,-hypervisor,kvm=off,hv_vendor_id=AuthenticAMD,topoext -device virtio-mouse-pci -device virtio-keyboard-pci -spice unix=on,addr=/run/lg$VMID.socket,disable-ticketing=on -device virtio-serial-pci -chardev spicevmc,id=vdagent,name=vdagent -device virtserialport,chardev=vdagent,name=com.redhat.spice.0&quot; &gt;&gt; /etc/pve/qemu-server/$VMID.conf
qm start $VMID
# Leave this SSH session running, as we will use it during Windows setup
</code></pre>
<p>We put <code>name=302</code> in <code>$VMID.conf</code> because by default, Proxmox will create IVSHMEM file suffixed with your VMID. However, we want to access Windows (VMID will be 302) through Looking Glass, so we need to match the name for IVSHMEM file.</p>
<p>The last command starts the VM for you.</p>
<h2 id="to-do"><a class="header" href="#to-do">To do</a></h2>
<p>lg client config</p>
<p>kvmfr0 permission</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="lg-client.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="win-vws.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="lg-client.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="win-vws.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
